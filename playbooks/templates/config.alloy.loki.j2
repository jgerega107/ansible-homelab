// Loki log discovery relabeling
discovery.relabel "docker_log_relabel" {
	targets = discovery.docker.linux.targets
	rule {
		source_labels = ["__meta_docker_container_name"]
		regex         = "/(.*)"
		target_label  = "container_name"
	}
	rule {
		source_labels = ["__meta_docker_container_label_com_docker_compose_project"]
		target_label  = "project_name"
	}
}

// Loki Log Collection
loki.source.docker "docker_log_scrape" {
	host          = "unix:///var/run/docker.sock"
	targets       = discovery.relabel.docker_log_relabel.output
	forward_to    = [loki.write.loki_remote.receiver]
}

loki.source.journal "journal_log_scrape"  {
	forward_to    = [loki.write.loki_remote.receiver]
	labels        = {"job" = "systemd-journal"}
	relabel_rules = loki.relabel.log_relabel.rules
}

loki.relabel "log_relabel" {
	forward_to = []

	rule {
		source_labels = ["__journal__systemd_unit"]
		target_label  = "service_name"
	}
}

// Loki Remote Write
loki.write "loki_remote" {
	endpoint {
		url = "{{ alloy_remote_log_endpoint }}"
{% if groups.remote is defined and inventory_hostname in groups.remote %}
		basic_auth {
			username = "{{ alloy_basic_auth_username }}"
			password = "{{ alloy_basic_auth_password }}"
		}
{% endif %}
	}
	external_labels = {"hostname" = constants.hostname}
}
