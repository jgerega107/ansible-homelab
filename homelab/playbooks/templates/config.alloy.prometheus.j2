// Prometheus Exporters
prometheus.exporter.self "alloy_exporter" { }

prometheus.scrape "alloy_exporter_job" {
	targets    = prometheus.exporter.self.alloy_exporter.targets
	forward_to = [prometheus.remote_write.prom_remote.receiver]
}

prometheus.scrape "docker_container_metrics_bridge" {
	targets    = discovery.relabel.docker_metric_relabel_bridge.output
	forward_to = [prometheus.remote_write.prom_remote.receiver]
}

prometheus.scrape "docker_container_metrics_host" {
	targets    = discovery.relabel.docker_metric_relabel_host.output
	forward_to = [prometheus.remote_write.prom_remote.receiver]
}

prometheus.exporter.cadvisor "docker" {
	docker_host = "unix:///var/run/docker.sock"
	docker_only = true
}

prometheus.scrape "base_exporters" {
	targets = array.concat([
		{"__address__" = string.format("%s:%s", constants.hostname, "9100"), "job" = "node_exporter"},
	], prometheus.exporter.cadvisor.docker.targets)
	forward_to = [prometheus.remote_write.prom_remote.receiver]
}

// Prometheus Remote Write
prometheus.remote_write "prom_remote" {
	endpoint {
		url = "{{ alloy_remote_write_endpoint }}"
		send_native_histograms = true
{% if groups.remote is defined and inventory_hostname in groups.remote %}
		basic_auth {
			username = "{{ alloy_basic_auth_username }}"
			password = "{{ alloy_basic_auth_password }}"
		}
{% endif %}
	}

	external_labels = {"hostname" = constants.hostname}
}